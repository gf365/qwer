<!DOCTYPE html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Space+Grotesk%3Awght%40400%3B500%3B700"
    />

    <title>検索結果 - QWER</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <link rel="stylesheet" href="./assets/css/site.css" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
      .search-hero {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .search-form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .search-form__control {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 0.5rem;
        align-items: center;
      }
      .search-input {
        border-radius: 999px;
        border: 1px solid #cbd5f5;
        padding: 0.9rem 1.2rem;
        font-size: 1rem;
        background: #fff;
      }
      .search-input:focus {
        outline: 2px solid #0f62fe;
        outline-offset: 2px;
      }
      .search-button {
        border-radius: 999px;
        border: none;
        padding: 0.9rem 1.5rem;
        font-weight: 600;
        color: #fff;
        background: linear-gradient(135deg, #0f62fe 0%, #5d42ff 100%);
        cursor: pointer;
      }
      .search-button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .search-hint {
        font-size: 0.9rem;
        color: #64748b;
      }
      .results-header {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .results-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        color: #475569;
        font-size: 0.95rem;
      }
      .result-status {
        font-weight: 600;
        color: #0f172a;
      }
      .results-grid {
        display: grid;
        gap: 1rem;
      }
      @media (min-width: 768px) {
        .results-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      .result-card {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 1rem;
        padding: 1.5rem;
        transition: border-color 0.2s ease, transform 0.2s ease;
      }
      .result-card:hover {
        border-color: #0f62fe;
        transform: translateY(-2px);
      }
      .result-link {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        text-decoration: none;
        color: inherit;
        height: 100%;
      }
      .result-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: #1e293b;
      }
      .result-badge {
        padding: 0.1rem 0.6rem;
        border-radius: 999px;
        background: #edf2ff;
        color: #4338ca;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .result-url {
        color: #64748b;
        font-size: 0.75rem;
      }
      .result-title {
        font-size: 1.15rem;
        font-weight: 700;
        margin: 0;
        color: #0f172a;
      }
      .result-snippet {
        font-size: 0.95rem;
        color: #475569;
        line-height: 1.6;
      }
      .result-snippet mark {
        background: #fff1a6;
        color: #0f172a;
        border-radius: 0.2rem;
        padding: 0 0.15rem;
      }
      .result-footer {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.9rem;
        color: #0f62fe;
        font-weight: 600;
      }
      .empty-state {
        text-align: center;
        padding: 2rem;
        color: #64748b;
      }
    </style>
  </head>
  <body>
    <div class="page-shell">
      <div class="layout-container flex h-full grow flex-col">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#e2e8f0] bg-white/95 backdrop-blur px-6 md:px-10 py-3 shadow-sm" role="banner">
          <div class="flex items-center gap-4 text-[#111a22]">
            <a href="./index.html" class="flex items-center gap-4 text-[#111a22]" aria-label="QWER Atlas ホーム">
              <div class="size-9 rounded-2xl bg-[#0f62fe] text-white flex items-center justify-center shadow-sm" aria-hidden="true">
                <svg viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="size-5"><path d="M8 8H40L34 24L40 40H8L14 24L8 8Z"></path></svg>
              </div>
              <div>
                <p class="text-[#0f172a] text-base font-semibold leading-tight tracking-[-0.015em] m-0">QWER Atlas</p>
                <p class="text-slate-500 text-xs font-medium leading-snug uppercase tracking-[0.25em] m-0">Knowledge Base</p>
              </div>
            </a>
          </div>
          <div class="flex flex-1 items-center gap-6 justify-end">
            <nav aria-label="メインメニュー" class="hidden lg:flex items-center">
              <ul class="flex items-center gap-8 m-0 p-0 list-none text-sm font-medium text-slate-600">
                <li><a class="hover:text-slate-900 transition" href="./index.html">ホーム</a></li>
                <li><a class="hover:text-slate-900 transition" href="./explore.html">学習ログ</a></li>
                <li><a class="hover:text-slate-900 transition" href="./discover.html">テンプレート</a></li>
                <li><a class="hover:text-slate-900 transition" href="./about.html">プロフィール</a></li>
                <li><a class="hover:text-slate-900 transition" href="./contact.html">運用/サポート</a></li>
              </ul>
            </nav>
            <form role="search" action="./search.html" method="get" class="hidden md:flex items-center gap-2 shrink-0" aria-label="サイト内検索">
              <label for="search-q" class="sr-only">ナレッジ検索</label>
              <input id="search-q" name="q" type="search" placeholder="記事・タグを検索" class="rounded-full border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:border-[#0f62fe]" />
              <button type="submit" class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 bg-[#e2e8f0] text-[#111a22] gap-2 text-sm font-semibold leading-normal tracking-[0.015em] min-w-0 px-3" aria-label="検索">
                <div class="text-[#111a22]" data-icon="MagnifyingGlass" data-size="20px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                </div>
              </button>
            </form>
            <div class="flex items-center gap-4 shrink-0">
              <div class="logged-out flex items-center gap-2">
                <a
                  class="rounded-full border border-slate-300 px-4 py-2 text-slate-700 text-sm font-medium leading-normal tracking-[0.01em] hover:bg-slate-50 transition min-w-[108px] text-center"
                  href="./signin.html"
                >
                  サインイン
                </a>
                <a
                  class="rounded-full bg-[#0f62fe] text-white px-5 py-2 text-sm font-semibold leading-normal tracking-[0.015em] hover:bg-[#0a46b5] transition min-w-[120px] text-center shadow-sm"
                  href="./signup.html"
                >
                  サインアップ
                </a>
              </div>
              <div class="logged-in items-center gap-4" style="display: none;">
                <span class="user-details text-sm text-slate-600"></span>
                <button id="logout-button" class="rounded-full bg-slate-200 text-slate-700 px-4 py-2 text-sm font-semibold leading-normal tracking-[0.015em] hover:bg-slate-300 transition">
                  ログアウト
                </button>
              </div>
            </div>
          </div>
        </header>
        <main class="page-main">
          <div class="page-content">
            <section class="hero-panel search-hero">
              <div>
                <p class="section-eyebrow">Search</p>
                <h1>全文検索</h1>
                <p>
                  QWER Atlas内の学習ログ、テンプレート、利用規約、ポリシーなどを横断検索します。タグやカテゴリ、本文の一部でも検索できるため、
                  過去のナレッジに素早くアクセスできます。
                </p>
              </div>
              <form id="search-form" class="search-form" role="search">
                <div class="search-form__control">
                  <input
                    type="search"
                    id="search-input"
                    name="q"
                    class="search-input"
                    placeholder="例：LLM、UEFN、プライバシー"
                    aria-label="検索ワードを入力"
                    autocomplete="off"
                  />
                  <button class="search-button" type="submit" id="search-submit">検索</button>
                </div>
                <p class="search-hint">⚡ タグ / カテゴリ / 本文をすべて対象にしています。スペースで複数キーワード検索も可能です。</p>
              </form>
            </section>
            <section class="surface-card section-stack">
              <div class="results-header">
                <h2 class="section-heading">結果一覧</h2>
                <div class="results-meta">
                  <span id="search-title" class="result-status">検索ワードを入力してください</span>
                  <span id="search-status"></span>
                </div>
              </div>
              <div id="search-results" class="results-grid" aria-live="polite"></div>
            </section>
          </div>
        </main>
        <footer class="border-t border-[#e2e8f0] bg-white/90 backdrop-blur">
          <div class="w-full max-w-[1100px] mx-auto px-6 py-10 flex flex-col gap-8">
            <div class="grid gap-8 md:grid-cols-3">
              <div class="flex flex-col gap-3">
                <p class="text-sm uppercase tracking-[0.3em] text-slate-500">QWER Atlas</p>
                <p class="text-slate-600 text-base leading-relaxed">
                  学習ログ、テンプレート、アーカイブが一つの場所に集約された個人ナレッジベース。モバイルでも同じ体験で、日々の積み上げがそのまま実績になります。
                </p>
                <div class="flex flex-wrap gap-2">
                  <span class="pill">OGP自動出力</span>
                  <span class="pill">SiteMap.xml</span>
                  <span class="pill">Analytics</span>
                </div>
              </div>
              <div>
                <p class="text-slate-900 font-semibold mb-3">サイトマップ</p>
                <ul class="space-y-2 text-slate-600 text-sm leading-relaxed">
                  <li><a class="hover:text-[#0f62fe] transition" href="./index.html">ホーム</a></li>
                  <li><a class="hover:text-[#0f62fe] transition" href="./explore.html">学習ログ</a></li>
                  <li><a class="hover:text-[#0f62fe] transition" href="./discover.html">テンプレート</a></li>
                  <li><a class="hover:text-[#0f62fe] transition" href="./join.html">実績アーカイブ</a></li>
                  <li><a class="hover:text-[#0f62fe] transition" href="./search.html">検索</a></li>
                </ul>
              </div>
              <div>
                <p class="text-slate-900 font-semibold mb-3">ポリシー / サポート</p>
                <ul class="space-y-2 text-slate-600 text-sm leading-relaxed">
                  <li><a class="hover:text-[#0f62fe] transition" href="./contact.html">運用相談</a></li>
                  <li><a class="hover:text-[#0f62fe] transition" href="./terms.html">利用規約</a></li>
                  <li><a class="hover:text-[#0f62fe] transition" href="./privacy.html">プライバシー</a></li>
                </ul>
                <p class="text-slate-500 text-xs mt-4">バックアップはMarkdown / HTMLで随時エクスポートできます。</p>
              </div>
            </div>
            <div class="flex flex-col md:flex-row items-center justify-between gap-4 text-sm text-slate-500">
              <p class="m-0">@2024 QWER Atlas — personal knowledge base for learning logs.</p>
              <div class="flex items-center gap-4">
                <a class="hover:text-[#0f62fe] transition" href="#">GitHub</a>
                <a class="hover:text-[#0f62fe] transition" href="#">Discord</a>
                <a class="hover:text-[#0f62fe] transition" href="#">Newsletter</a>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDcMSmPzmgYKufn3u0Axw3QMhI06LTbMVI",
        authDomain: "qwer-auth.firebaseapp.com",
        projectId: "qwer-auth",
        storageBucket: "qwer-auth.firebasestorage.app",
        messagingSenderId: "1049566332028",
        appId: "1:1049566332028:web:3f45b59c4ab40362a475f9"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      window.firebaseAuth = {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
        auth
      };
    </script>
    <script src="./assets/js/auth.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('search-input');
        const searchForm = document.getElementById('search-form');
        const searchTitle = document.getElementById('search-title');
        const searchStatus = document.getElementById('search-status');
        const resultsContainer = document.getElementById('search-results');
        const searchButton = document.getElementById('search-submit');
        const params = new URLSearchParams(window.location.search);
        const initialQuery = params.get('q')?.trim() || '';

        const searchableFiles = [
          './index.html',
          './about.html',
          './contact.html',
          './discover.html',
          './explore.html',
          './join.html',
          './privacy.html',
          './signin.html',
          './signup.html',
          './terms.html'
        ];

        if (initialQuery) {
          searchInput.value = initialQuery;
          runSearch(initialQuery);
        } else {
          resultsContainer.innerHTML =
            '<div class="empty-state">検索バーにキーワードを入力すると結果が表示されます。</div>';
        }

        searchForm.addEventListener('submit', event => {
          event.preventDefault();
          const query = searchInput.value.trim();
          if (!query) {
            searchTitle.textContent = '検索ワードを入力してください';
            searchStatus.textContent = '';
            resultsContainer.innerHTML =
              '<div class="empty-state">検索ワードを入力すると、全文検索が開始されます。</div>';
            return;
          }
          const newUrl = `${window.location.pathname}?q=${encodeURIComponent(query)}`;
          window.history.replaceState({}, '', newUrl);
          runSearch(query);
        });

        async function runSearch(query) {
          searchTitle.textContent = `「${query}」の検索結果`;
          searchStatus.textContent = '検索中...';
          searchButton.disabled = true;
          resultsContainer.innerHTML =
            '<div class="empty-state">インデックスを走査しています...</div>';

          const results = await search(query, searchableFiles);
          displayResults(results, query);
          searchButton.disabled = false;
        }

        async function search(query, files) {
          const results = [];
          const q = query.toLowerCase();

          for (const file of files) {
            try {
              const response = await fetch(file);
              if (!response.ok) {
                console.error(`Error fetching ${file}: ${response.statusText}`);
                continue;
              }
              const html = await response.text();
              const plainHtml = html.toLowerCase();

              if (!plainHtml.includes(q)) continue;

              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              const title = doc.querySelector('title')?.textContent?.trim() || file;
              const description =
                doc.querySelector('meta[name="description"]')?.content?.trim() || '';
              const snippet = createSnippet(doc.body?.textContent || '', query);
              results.push({
                file,
                title,
                description,
                snippet,
                badge: getBadge(file)
              });
            } catch (error) {
              console.error(`Error processing ${file}:`, error);
            }
          }
          return results;
        }

        function displayResults(results, query) {
          resultsContainer.innerHTML = '';

          if (results.length === 0) {
            searchStatus.textContent = '一致したページはありませんでした。';
            resultsContainer.innerHTML =
              '<div class="empty-state">条件を変えて再度検索してみてください。</div>';
            return;
          }

          searchStatus.textContent = `${results.length}件ヒット`;
          const fragment = document.createDocumentFragment();

          results.forEach(result => {
            const card = document.createElement('article');
            card.className = 'result-card';

            const link = document.createElement('a');
            link.href = result.file;
            link.className = 'result-link';
            link.setAttribute('aria-label', `${result.title}のページを開く`);

            const meta = document.createElement('div');
            meta.className = 'result-meta';

            const badge = document.createElement('span');
            badge.className = 'result-badge';
            badge.textContent = result.badge;

            const url = document.createElement('span');
            url.className = 'result-url';
            url.textContent = result.file.replace('./', '/');

            meta.appendChild(badge);
            meta.appendChild(url);

            const title = document.createElement('h3');
            title.className = 'result-title';
            title.textContent = result.title;

            const snippet = document.createElement('p');
            snippet.className = 'result-snippet';
            snippet.innerHTML = highlightQuery(result.snippet || result.description, query);

            const footer = document.createElement('div');
            footer.className = 'result-footer';
            footer.innerHTML = '詳細を表示 <span aria-hidden="true">↗</span>';

            link.appendChild(meta);
            link.appendChild(title);
            link.appendChild(snippet);
            link.appendChild(footer);
            card.appendChild(link);
            fragment.appendChild(card);
          });

          resultsContainer.appendChild(fragment);
        }

        function createSnippet(text, query) {
          const condensed = text.replace(/\s+/g, ' ').trim();
          if (!condensed) return '';

          const lowerText = condensed.toLowerCase();
          const lowerQuery = query.toLowerCase();
          const index = lowerText.indexOf(lowerQuery);

          if (index === -1) return condensed.slice(0, 140) + (condensed.length > 140 ? '…' : '');

          const start = Math.max(0, index - 70);
          const end = Math.min(condensed.length, index + query.length + 70);
          const prefix = start > 0 ? '…' : '';
          const suffix = end < condensed.length ? '…' : '';
          return `${prefix}${condensed.slice(start, end)}${suffix}`;
        }

        function highlightQuery(text, query) {
          if (!text) return '';
          const safeText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`(${escaped})`, 'gi');
          return safeText.replace(regex, '<mark>$1</mark>');
        }

        function getBadge(file) {
          const map = {
            './index.html': 'Home',
            './explore.html': 'Log',
            './discover.html': 'Template',
            './join.html': 'Archive',
            './about.html': 'About',
            './contact.html': 'Contact',
            './privacy.html': 'Policy',
            './terms.html': 'Policy',
            './signin.html': 'Auth',
            './signup.html': 'Auth'
          };
          return map[file] || 'Page';
        }
      });
    </script>
  </body>
</html>
